
name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # allows manual run from the Actions tab

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  llm_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify gh CLI and auth
        run: |
          gh --version || (echo "gh CLI missing on runner" && exit 1)
          echo "Actor: ${{ github.actor }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install gh-models extension
        run: gh extension install https://github.com/github/gh-models
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          {
            echo 'changeset<<EOF'
            gh pr diff "${{ github.event.pull_request.number }}" --repo "${{ github.repository }}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Build prompt template
        run: |
          cat << 'EOF' > prompt.yml
          name: code-review
          model: openai/gpt-4o-mini
          system: You are a rigorous, concise code reviewer.
          prompt: |
            Act as a senior code reviewer. Given the unified diff below:
            - Summarize the intent of the change.
            - Flag security risks, performance issues, and code smells.
            - Suggest specific, minimal edits (patch-style if possible).
            - If nothing critical, end with: "No blockers; consider nits".
            Diff:
            {{input}}
          temperature: 0.2
          top_p: 0.9
          EOF

      - name: Run model on diff
        id: review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "${{ steps.diff.outputs.changeset }}" ]; then
            echo "No changes detected in diff; skipping model run." >&2
            printf "No changes found in the PR diff.\n" > review.md
          else
            gh models run --file prompt.yml \
              --var input="${{ steps.diff.outputs.changeset }}" \
              --max-tokens 2000 \
              > review.md || echo ":warning: AI review could not be generated." > review.md
          fi

      - name: Comment on PR with AI review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --body-file review.md || echo "[Info] Comment step failed."
